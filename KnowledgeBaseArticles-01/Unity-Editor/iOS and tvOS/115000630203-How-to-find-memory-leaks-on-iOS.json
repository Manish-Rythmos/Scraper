[{"title":"How to find memory leaks on iOS","authorName":"Alejandro Lopez.","createdDate":"2017-02-02T11:40:21Z","updatedDate":"2017-09-29T23:06:51Z","labels":["iOS","memory","memory leak"],"sections":[{"title":"Symptoms","content":["\n<li>You need to profile the memory allocated on an iOS device.</li>\n<li>Your app crashes after running out of memory.</li>\n<li>You are getting memory warnings.</li>\n"]},{"title":"Resolution","content":["You must attempt to identify any memory leaks.","The code below analyzes the memory of the Player for iOS or OSX with Xcode and the Instruments allocation tool.","For the purpose of this example, some AssetBundles are being loaded but the WWW object is not unloaded.","for (int i = 0; i &lt; 100; i++) \n{\nWWW www = new WWW (bundleURL);\nyield return www;\nAssetBundle bundle = www.assetBundle;\nbundle.LoadAllAssets ();\nbundle.Unload (true);\n}\n","To try and identify the issue:","1. Build and run the Project.","2. Open the <strong>Debug Navigator</strong> in the <strong>Navigators</strong> area and then click on <strong>Memory</strong> to display the memory graphs.","<img src=\"/hc/en-us/article_attachments/115001591603/1.png\" alt=\"\" width=\"670\" height=\"469\">","The graph in blue above shows that there are two memory peaks, but it doesn&apos;t show which functions are using this memory. Instruments can be used to see the methods that allocated the memory.","2. In Xcode, select <strong>Product/Profile</strong> (Cmd+I).","<img src=\"/hc/en-us/article_attachments/115001591623/2.png\" alt=\"\" width=\"670\" height=\"376\">","3. Select the allocation tool (<strong>Allocations</strong>), which will provide you with detailed information on all created objects and the memory they are using.","<img src=\"/hc/en-us/article_attachments/115001591643/3.png\" alt=\"\" width=\"670\" height=\"414\">","4. Click the <strong>record</strong> button to start the the application on the device and record the session.","5. On the Detail Panel, select <strong>Call Trees</strong>.","6. Pause the game and in the Track panel select part of the graph and check the hierarchy of the call tree. This will show you how much memory was allocated for the selected piece of the graph, and if you go down in the hierarchy you will find the memory allocation.","<strong>Finding a possible memory leak</strong>","A memory leak happens when you allocate memory but it is not returned to the operating system or reused.","Common reasons for memory leaks include:","\n<li>WWW objects that have not been unloaded</li>\n<li>Static references</li>\n<li>Problems with between Scenes&#xA0;</li>\n<li>Objects not being unloaded correctly</li>\n<li>Render Textures not being unloaded correctly</li>\n<li>AssetBundles not being unloaded correctly</li>\n","<img src=\"/hc/en-us/article_attachments/115001643366/A.png\" alt=\"\" width=\"320\" height=\"415\">","1. Tick the <strong>Discard events for freed memory</strong> checkbox so you can analyze only the memory that is not de-allocated.","2. Run the game for an extended period of time and check if there is a peak on the graph that doesn&apos;t get deleted after some time or recurs after several runs of the game.","Below is an example of a memory leak caused by the WWW object not being unloaded:","<img src=\"/hc/en-us/article_attachments/115001603166/4.png\" alt=\"\" width=\"670\" height=\"218\">","In this example, some of the memory peaks that represent the allocations are released but some persist.","3. Pause and select the peak on the graph to open the calls tree, and check to see if the memory is allocated from the same function each time.","<img src=\"/hc/en-us/article_attachments/115001603186/5.png\" alt=\"\" width=\"670\" height=\"412\">","<strong>Mark generation</strong>","The second test to find a memory leak is to use the mark generation tool.","<img src=\"/hc/en-us/article_attachments/115001643406/B.png\" alt=\"\" width=\"320\" height=\"478\">","1. In the Inspector panel, click the <strong>Display Settings</strong> button and then the button labelled <strong>Mark Generation</strong>.","2. Create some mark generations using this button. When a mark is generated, you will see a red flag appear in the track.","3. Check that the memory does not continue to grow while repeatedly performing the same set of operations, and note that each generation includes a list of allocations that has occurred since the previous generation.","4. Take samples when you load a new Scene or destroy objects to check if you have objects that remain in memory.","<img src=\"/hc/en-us/article_attachments/115001603246/6.png\" alt=\"\" width=\"672\" height=\"270\">","You need you do several runs and let the game run for some time as the memory allocated can be released or reused later.","You also need to build in development mode and enable the generation of dSYM in Xcode to read the call stack properly.","<img src=\"/hc/en-us/article_attachments/115001603286/7.png\" alt=\"\" width=\"671\" height=\"136\">","Another useful tool for inspecting memory usage is the <a href=\"https://bitbucket.org/Unity-Technologies/memoryprofiler\">Unity Memory Profiler</a>.&#xA0;After you game have been running for some time, you can load an empty Scene and use the Memory Profiler take a memory snapshot and check what objects are still in memory."]},{"title":"More Information ","content":["For more information, consult the following:","\n<li><a href=\"https://developer.apple.com/library/content/documentation/DeveloperTools/Conceptual/InstrumentsUserGuide/Instrument-Allocations.html\">Apple documentation on the Allocations instrument</a></li>\n<li><a href=\"https://developer.apple.com/library/content/documentation/Performance/Conceptual/ManagingMemory/Articles/FindingPatterns.html\">Apple documentation on tracking memory usage</a></li>\n<li><a href=\"https://blogs.unity3d.com/2016/02/01/profiling-with-instruments/\">Unity blog on profiling with Instruments</a></li>\n<li><a href=\"https://docs.unity3d.com/Manual/ProfilerMemory.html\">Memory Profiler documentation</a></li>\n<li><a href=\"https://bitbucket.org/Unity-Technologies/memoryprofiler\">Unity Memory Profiler on Bitbucket</a></li>\n<li><a href=\"https://developer.apple.com/library/content/documentation/DeveloperTools/Conceptual/InstrumentsUserGuide/FindingAbandonedMemory.html\">Apple documentation on finding abandoned memory</a></li>\n<li><a href=\"https://support.unity3d.com/hc/en-us/articles/115000172606\">Article on iOs runtime memory tracking</a></li>\n"]}]}]